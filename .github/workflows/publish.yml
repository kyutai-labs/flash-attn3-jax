name: Publish to PyPI
on:
  push:
    tags: [v*]
  workflow_dispatch:  # Allows manual trigger from GitHub UI
    inputs:
      publish_target:
        description: Publish target
        required: true
        default: testpypi
        type: choice
        options: [testpypi, pypi]
jobs:
  build_wheels:
    name: Build wheels for ${{ matrix.python }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: [cp311, cp312]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_BUILD: ${{ matrix.python }}-manylinux_x86_64
          CIBW_ARCHS: x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28  # AlmaLinux 8, modern enough for CUDA 12 but should ensure broad compatibility
          CIBW_BEFORE_ALL: |
            dnf install -y yum-utils
            yum-config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
            dnf clean all
            dnf -y install cuda-nvcc-12-4 cuda-cudart-devel-12-4
          CIBW_ENVIRONMENT: |
            PATH="/usr/local/cuda-12.4/bin:$PATH" \
            LD_LIBRARY_PATH="/usr/local/cuda-12.4/lib64:$LD_LIBRARY_PATH" \
            FLASH_ATTN_CUDA_ARCHS="90" \
            CMAKE_BUILD_PARALLEL_LEVEL="1"
          CIBW_BUILD_VERBOSITY: 1
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.python }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  # Publish to TestPyPI (for testing)
  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build_wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target
      == 'testpypi'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/flash-attn3-jax
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist/
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  # Publish to PyPI (production)
  publish-pypi:
    name: Publish to PyPI
    needs: [build_wheels]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch'
      && github.event.inputs.publish_target == 'pypi')
    environment:
      name: pypi
      url: https://pypi.org/p/flash-attn3-jax
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist/
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
